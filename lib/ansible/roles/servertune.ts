import { Role } from "../role.ts";
import { sysctl } from "../tasks/sysctl.ts";

export function tuneSystcl() {
  return new Role("server-tune").tasks([
    sysctl({
      "vm.vfs_cache_pressure": "50",
      "net.ipv6.conf.all.disable_ipv6": "1",
      "net.ipv6.conf.default.disable_ipv6": "1",
      "fs.file-max": "2097152",
      "fs.suid_dumpable": "0",
      "kernel.msgmnb": "65536",
      "kernel.msgmax": "65536",
      "kernel.shmmax": "68719476736",
      "kernel.shmall": "4294967296",
      "kernel.sysrq": "0",
      "kernel.core_uses_pid": "1",
      "net.core.somaxconn": "65535",
      "net.core.netdev_max_backlog": "262144",
      "net.core.optmem_max": "25165824",
      "net.core.rmem_default": "31457280",
      "net.core.rmem_max": "67108864",
      "net.core.wmem_default": "31457280",
      "net.core.wmem_max": "67108864",
      "net.ipv4.tcp_max_tw_buckets": "6000",
      "net.ipv4.tcp_sack": "1",
      "net.ipv4.tcp_window_scaling": "1",
      "net.ipv4.tcp_rme": "10240 87380 12582912",
      "net.ipv4.tcp_wme": "10240 87380 12582912",
      "net.ipv4.ip_local_port_range": "1024 65535",
      "net.ipv4.tcp_keepalive_time": "30",
      "net.ipv4.tcp_max_syn_backlog": "262144",
      "net.ipv4.tcp_timestamps": "0",
      "net.ipv4.tcp_synack_retries": "1",
      "net.ipv4.tcp_syn_retries": "1",
      "net.ipv4.tcp_tw_recycle": "1",
      "net.ipv4.tcp_tw_reuse": "1",
      "net.ipv4.tcp_mem": "94500000 915000000 927000000",
      "net.ipv4.tcp_fin_timeout": "1",
      "net.ipv4.tcp_max_orphans": "3276800",
      "net.ipv4.tcp_syncookies": "1",
      "vm.dirty_background_ratio": "5",
      "vm.dirty_ratio": "10",
      "vm.swappines": "2",
      "net.ipv4.ip_forward": "1",
    }),
  ]);
}
